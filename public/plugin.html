<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰«ç ä¸Šä¼ </title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      text-align: center;
      max-width: 400px;
      width: 100%;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
      color: #000;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 24px;
    }

    .qr-wrapper {
      background: white;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      margin-bottom: 16px;
      display: inline-block;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    #qrcode {
      display: inline-block;
    }

    #qrcode img {
      display: block;
      border-radius: 4px;
    }

    .status {
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      margin-top: 16px;
      transition: all 0.3s ease;
    }

    .status.waiting {
      background: #fff9e6;
      color: #856404;
      border: 1px solid #ffc107;
    }

    .status.connected {
      background: #e8f5e9;
      color: #155724;
      border: 1px solid #28a745;
    }

    .status.success {
      background: #e3f2fd;
      color: #0d47a1;
      border: 1px solid #2196f3;
    }

    .loading {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #ffc107;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .icon {
      font-size: 16px;
      margin-right: 6px;
    }

    /* ç®€æ´çš„æ·¡å…¥åŠ¨ç”» */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .container {
      animation: fadeIn 0.4s ease-out;
    }

    /* å“åº”å¼ */
    @media (max-width: 480px) {
      .title {
        font-size: 18px;
      }
      
      .qr-wrapper {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">ğŸ“± æ‰«ç ä¸Šä¼ å›¾ç‰‡</h1>
    <p class="subtitle">ä½¿ç”¨æ‰‹æœºæ‰«æä¸‹æ–¹äºŒç»´ç </p>
    
    <div class="qr-wrapper">
      <div id="qrcode"></div>
    </div>

    <div class="status waiting" id="status">
      <span class="loading"></span>
      <span>ç­‰å¾…æ‰‹æœºè¿æ¥...</span>
    </div>
  </div>

  <script>
    const socket = io();
    const roomId = generateRoomId();

    // ç”Ÿæˆéšæœºæˆ¿é—´ ID
    function generateRoomId() {
      return Math.random().toString(36).substring(2, 10).toUpperCase();
    }

    // ç”ŸæˆäºŒç»´ç 
    function generateQRCode() {
      const url = `${window.location.origin}/upload/${roomId}`;
      new QRCode(document.getElementById('qrcode'), {
        text: url,
        width: 200,
        height: 200,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
    }

    // æ›´æ–°çŠ¶æ€
    function updateStatus(text, type = 'waiting') {
      const statusEl = document.getElementById('status');
      statusEl.className = `status ${type}`;
      
      let icon = '';
      if (type === 'waiting') {
        icon = '<span class="loading"></span>';
      } else if (type === 'connected') {
        icon = '<span class="icon">âœ“</span>';
      } else if (type === 'success') {
        icon = '<span class="icon">âœ“</span>';
      }
      
      statusEl.innerHTML = icon + '<span>' + text + '</span>';
    }

    // Socket è¿æ¥
    socket.on('connect', () => {
      console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
      socket.emit('create-room', roomId);
    });

    socket.on('room-created', (id) => {
      console.log('æˆ¿é—´å·²åˆ›å»º:', id);
      generateQRCode();
    });

    // ç§»åŠ¨ç«¯è¿æ¥
    socket.on('mobile-connected', () => {
      console.log('æ‰‹æœºå·²è¿æ¥');
      updateStatus('æ‰‹æœºå·²è¿æ¥ï¼Œç­‰å¾…ä¸Šä¼ ...', 'connected');
    });

    // æ¥æ”¶å›¾ç‰‡
    socket.on('image-received', (imageData) => {
      console.log('æ”¶åˆ°å›¾ç‰‡');
      updateStatus('å›¾ç‰‡å·²æ¥æ”¶ï¼', 'success');
      
      // å‘é€æ¶ˆæ¯ç»™çˆ¶çª—å£ï¼ˆChrome æ’ä»¶ï¼‰
      if (window.parent !== window) {
        try {
          window.parent.postMessage({
            type: 'qr-upload-image',
            imageData: imageData
          }, '*');
          console.log('å·²å‘é€å›¾ç‰‡æ•°æ®ç»™æ’ä»¶');
        } catch (e) {
          console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', e);
        }
      }
      
      // çŸ­æš‚å»¶è¿Ÿåæ¢å¤ç­‰å¾…çŠ¶æ€ï¼ˆç”¨æˆ·å¯èƒ½ç»§ç»­ä¸Šä¼ ï¼‰
      setTimeout(() => {
        updateStatus('å¯ä»¥ç»§ç»­ä¸Šä¼ æ›´å¤šå›¾ç‰‡', 'connected');
      }, 2000);
    });

    // æ–­å¼€è¿æ¥
    socket.on('disconnect', () => {
      console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
      updateStatus('è¿æ¥å·²æ–­å¼€', 'waiting');
    });
  </script>
</body>
</html>

